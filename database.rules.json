{
  "rules": {
    "rooms": {
      "$roomCode": {
        // Authenticated users can read rooms they're part of, or any room (to join)
        ".read": "auth != null",
        // Write allowed if: creating new room OR user is host OR user is a player in the room
        ".write": "auth != null && (
          !data.exists() ||
          data.child('hostId').val() == auth.uid ||
          data.child('players').child(auth.uid).exists()
        )",
        "players": {
          "$playerId": {
            ".validate": "newData.hasChildren(['id', 'name', 'avatar', 'isHost', 'score', 'joinedAt', 'isOnline'])",
            // Host can write anything, player can only CREATE their own node (not update it at this level)
            ".write": "auth != null && (data.parent().parent().child('hostId').val() == auth.uid || ($playerId == auth.uid && !data.exists()))",
            // Individual field rules for players (not host)
            "name": {
              ".write": "auth != null && $playerId == auth.uid"
            },
            "avatar": {
              ".write": "auth != null && $playerId == auth.uid"
            },
            "isOnline": {
              ".write": "auth != null && $playerId == auth.uid"
            },
            "team": {
              // Only host can assign teams
              ".write": "auth != null && data.parent().parent().parent().child('hostId').val() == auth.uid"
            },
            "score": {
              // SECURITY: Only Cloud Functions can modify scores (via Admin SDK)
              // Players and host cannot modify scores directly
              ".write": false
            },
            "id": {
              ".write": "auth != null && $playerId == auth.uid"
            },
            "isHost": {
              // Only set once during room creation
              ".write": "auth != null && !data.exists()"
            },
            "joinedAt": {
              // Only set once when joining
              ".write": "auth != null && !data.exists()"
            }
          }
        },
        "state": {
          ".validate": "newData.hasChild('status') && newData.hasChild('phaseState')",
          // Host can modify most game state fields
          ".write": "auth != null && data.parent().child('hostId').val() == auth.uid",
          "scores": {
            // SECURITY: Team scores only modifiable by Cloud Functions (via Admin SDK)
            ".write": false
          },
          "playersReady": {
            // Players can mark themselves as ready
            ".write": "auth != null && data.parent().parent().child('players').child(auth.uid).exists()"
          }
        },
        "hostId": {
          // Host ID can only be set on room creation, cannot be changed
          ".write": "auth != null && !data.exists()"
        },
        "customQuestions": {
          // SECURITY: Questions are written by Cloud Functions only (via Admin SDK)
          // This ensures answers are never included in client-visible data
          ".write": false
        },
        "revealedAnswers": {
          // SECURITY: Revealed answers are written by Cloud Functions only (via Admin SDK)
          // Answers are revealed after player submission is validated
          ".read": "auth != null",
          ".write": false
        },
        "generationStatus": {
          // Status of background question generation (Pub/Sub)
          // Readable by all players, writable only by Cloud Functions
          ".read": "auth != null",
          ".write": false
        }
      }
    },
    "gameData": {
      // SECURITY: Private answer data - completely inaccessible to clients
      // Only Cloud Functions (via Admin SDK) can read/write
      ".read": false,
      ".write": false
    },
    "soloSessions": {
      "$userId": {
        // Solo sessions - only the owner can read/write their own session
        // Solo mode is local-only (no multiplayer cheating concerns)
        ".read": "auth != null && auth.uid == $userId",
        ".write": "auth != null && auth.uid == $userId"
      }
    },
    "userHistory": {
      "$playerId": {
        // SEC-006: Only owner can read and write their own history
        ".read": "auth != null && auth.uid == $playerId",
        ".write": "auth != null && auth.uid == $playerId"
      }
    },
    "cursors": {
      "$roomCode": {
        // SEC-007: Only players in this room can read cursors
        ".read": "auth != null && root.child('rooms').child($roomCode).child('players').child(auth.uid).exists()",
        "$playerId": {
          // Only the owner can write their own cursor position (if they're in the room)
          ".write": "auth != null && auth.uid == $playerId && root.child('rooms').child($roomCode).child('players').child(auth.uid).exists()",
          ".validate": "newData.hasChildren(['x', 'y', 'isTouch', 'timestamp'])"
        }
      }
    },
    ".read": false,
    ".write": false
  }
}
