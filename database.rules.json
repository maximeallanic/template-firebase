{
  "rules": {
    "rooms": {
      "$roomId": {
        // Authenticated users can read rooms they're part of, or any room (to join)
        ".read": "auth != null",
        // Write allowed if: creating new room OR user is host OR user is a player in the room
        ".write": "auth != null && (
          !data.exists() ||
          data.child('hostId').val() == auth.uid ||
          data.child('players').child(auth.uid).exists()
        )",
        "players": {
          "$playerId": {
            ".validate": "newData.hasChildren(['id', 'name', 'avatar', 'isHost', 'score', 'joinedAt', 'isOnline'])",
            // Host can write anything, player can only CREATE their own node (not update it at this level)
            ".write": "auth != null && (data.parent().parent().child('hostId').val() == auth.uid || ($playerId == auth.uid && !data.exists()))",
            // Individual field rules for players (not host)
            "name": {
              ".write": "auth != null && $playerId == auth.uid"
            },
            "avatar": {
              ".write": "auth != null && $playerId == auth.uid"
            },
            "isOnline": {
              ".write": "auth != null && $playerId == auth.uid"
            },
            "team": {
              // Only host can assign teams
              ".write": "auth != null && data.parent().parent().parent().child('hostId').val() == auth.uid"
            },
            "score": {
              // SECURITY: Only host can modify scores - prevents cheating
              ".write": "auth != null && data.parent().parent().parent().child('hostId').val() == auth.uid"
            },
            "id": {
              ".write": "auth != null && $playerId == auth.uid"
            },
            "isHost": {
              // Only set once during room creation
              ".write": "auth != null && !data.exists()"
            },
            "joinedAt": {
              // Only set once when joining
              ".write": "auth != null && !data.exists()"
            }
          }
        },
        "state": {
          ".validate": "newData.hasChild('status') && newData.hasChild('phaseState')",
          // Only host can modify game state
          ".write": "auth != null && data.parent().child('hostId').val() == auth.uid"
        },
        "hostId": {
          // Host ID can only be set on room creation, cannot be changed
          ".write": "auth != null && !data.exists()"
        }
      }
    },
    "userHistory": {
      "$playerId": {
        // Any authenticated user can read (for exhaustion check), only owner can write
        ".read": "auth != null",
        ".write": "auth != null && auth.uid == $playerId"
      }
    },
    "cursors": {
      "$roomCode": {
        // Any authenticated user can read cursors in a room
        ".read": "auth != null",
        "$playerId": {
          // Only the owner can write their own cursor position
          ".write": "auth != null && auth.uid == $playerId",
          ".validate": "newData.hasChildren(['x', 'y', 'isTouch', 'timestamp'])"
        }
      }
    },
    ".read": false,
    ".write": false
  }
}
