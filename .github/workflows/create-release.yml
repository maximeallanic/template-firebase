name: Create Release

on:
  workflow_dispatch:
    inputs:
      bump_type:
        description: 'Version bump type'
        required: true
        type: choice
        options:
          - patch
          - minor
          - major
      generate_ai_summary:
        description: 'Generate AI summary for changelog'
        required: false
        type: boolean
        default: true
      prerelease:
        description: 'Mark as pre-release'
        required: false
        type: boolean
        default: false

env:
  NODE_VERSION: '22'

jobs:
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: read
    outputs:
      new_version: ${{ steps.bump.outputs.new_version }}
      changelog: ${{ steps.changelog.outputs.changelog }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Get current version
        id: current
        run: |
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "Current version: $CURRENT_VERSION"

      - name: Bump version
        id: bump
        run: |
          node scripts/bump-version.cjs ${{ github.event.inputs.bump_type }}
          NEW_VERSION=$(node -p "require('./package.json').version")
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "New version: $NEW_VERSION"

      - name: Get last tag
        id: last_tag
        run: |
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [ -z "$LAST_TAG" ]; then
            # No previous tag, get first commit
            LAST_TAG=$(git rev-list --max-parents=0 HEAD)
            echo "No previous tag found, using first commit: $LAST_TAG"
          fi
          echo "last_tag=$LAST_TAG" >> $GITHUB_OUTPUT

      - name: Generate changelog
        id: changelog
        run: |
          NEW_VERSION="v${{ steps.bump.outputs.new_version }}"
          LAST_TAG="${{ steps.last_tag.outputs.last_tag }}"

          echo "Generating changelog from $LAST_TAG to HEAD..."

          # Get commits since last tag
          COMMITS=$(git log ${LAST_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges)

          # Categorize commits
          FEATURES=$(echo "$COMMITS" | grep -iE "^- (feat|feature|add)" || true)
          FIXES=$(echo "$COMMITS" | grep -iE "^- (fix|bug|patch)" || true)
          IMPROVEMENTS=$(echo "$COMMITS" | grep -iE "^- (improve|enhance|update|refactor|perf)" || true)
          DOCS=$(echo "$COMMITS" | grep -iE "^- (doc|readme)" || true)
          CI=$(echo "$COMMITS" | grep -iE "^- (ci|build|deploy)" || true)
          OTHER=$(echo "$COMMITS" | grep -viE "^- (feat|feature|add|fix|bug|patch|improve|enhance|update|refactor|perf|doc|readme|ci|build|deploy)" || true)

          # Build changelog
          CHANGELOG="## What's Changed in $NEW_VERSION\n\n"

          if [ -n "$FEATURES" ]; then
            CHANGELOG+="### New Features\n$FEATURES\n\n"
          fi

          if [ -n "$FIXES" ]; then
            CHANGELOG+="### Bug Fixes\n$FIXES\n\n"
          fi

          if [ -n "$IMPROVEMENTS" ]; then
            CHANGELOG+="### Improvements\n$IMPROVEMENTS\n\n"
          fi

          if [ -n "$DOCS" ]; then
            CHANGELOG+="### Documentation\n$DOCS\n\n"
          fi

          if [ -n "$CI" ]; then
            CHANGELOG+="### CI/CD\n$CI\n\n"
          fi

          if [ -n "$OTHER" ]; then
            CHANGELOG+="### Other Changes\n$OTHER\n\n"
          fi

          # Save changelog to file
          echo -e "$CHANGELOG" > /tmp/changelog.md

          # Save to output (escape newlines)
          {
            echo 'changelog<<EOF'
            echo -e "$CHANGELOG"
            echo 'EOF'
          } >> $GITHUB_OUTPUT

          echo "Changelog generated:"
          cat /tmp/changelog.md

      - name: Generate AI Summary
        id: ai_summary
        if: github.event.inputs.generate_ai_summary == 'true'
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          if [ -z "$GEMINI_API_KEY" ]; then
            echo "GEMINI_API_KEY not set, skipping AI summary"
            echo "ai_summary=" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Read changelog
          CHANGELOG=$(cat /tmp/changelog.md)

          # Escape for JSON
          CHANGELOG_ESCAPED=$(echo "$CHANGELOG" | jq -Rs .)

          # Create prompt
          PROMPT="You are a technical writer. Create a brief, engaging summary (2-3 sentences) of this changelog for a party quiz game called 'Spicy vs Sweet'. Focus on the most impactful changes for users. Be concise and friendly.\n\nChangelog:\n$CHANGELOG_ESCAPED"

          # Call Gemini API
          RESPONSE=$(curl -s "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=$GEMINI_API_KEY" \
            -H 'Content-Type: application/json' \
            -d "{
              \"contents\": [{
                \"parts\": [{
                  \"text\": $(echo "$PROMPT" | jq -Rs .)
                }]
              }],
              \"generationConfig\": {
                \"temperature\": 0.7,
                \"maxOutputTokens\": 200
              }
            }")

          # Extract summary
          AI_SUMMARY=$(echo "$RESPONSE" | jq -r '.candidates[0].content.parts[0].text // empty' 2>/dev/null || echo "")

          if [ -n "$AI_SUMMARY" ]; then
            echo "AI Summary generated:"
            echo "$AI_SUMMARY"
            {
              echo 'ai_summary<<EOF'
              echo "$AI_SUMMARY"
              echo 'EOF'
            } >> $GITHUB_OUTPUT
          else
            echo "Failed to generate AI summary"
            echo "API Response: $RESPONSE"
            echo "ai_summary=" >> $GITHUB_OUTPUT
          fi

      - name: Update CHANGELOG.md
        run: |
          NEW_VERSION="v${{ steps.bump.outputs.new_version }}"
          DATE=$(date +%Y-%m-%d)
          AI_SUMMARY="${{ steps.ai_summary.outputs.ai_summary }}"

          # Create new changelog entry
          {
            echo "# Changelog"
            echo ""
            echo "All notable changes to Spicy vs Sweet will be documented in this file."
            echo ""
            echo "---"
            echo ""
            echo "## [$NEW_VERSION] - $DATE"
            echo ""

            if [ -n "$AI_SUMMARY" ]; then
              echo "> $AI_SUMMARY"
              echo ""
            fi

            cat /tmp/changelog.md | tail -n +3  # Skip the "## What's Changed" header
            echo ""
            echo "---"
            echo ""
          } > /tmp/new_changelog.md

          # Append existing changelog (if exists, skip header)
          if [ -f "CHANGELOG.md" ]; then
            tail -n +8 CHANGELOG.md >> /tmp/new_changelog.md 2>/dev/null || true
          fi

          mv /tmp/new_changelog.md CHANGELOG.md
          echo "Updated CHANGELOG.md"

      - name: Commit version bump
        run: |
          NEW_VERSION="v${{ steps.bump.outputs.new_version }}"
          git add package.json CHANGELOG.md
          git add android/app/build.gradle 2>/dev/null || true
          git add ios/App/App.xcodeproj/project.pbxproj 2>/dev/null || true
          git commit -m "chore(release): bump version to $NEW_VERSION"
          git push origin ${{ github.ref_name }}

      - name: Create and push tag
        run: |
          NEW_VERSION="v${{ steps.bump.outputs.new_version }}"
          git tag -a "$NEW_VERSION" -m "Release $NEW_VERSION"
          git push origin "$NEW_VERSION"

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          NEW_VERSION="v${{ steps.bump.outputs.new_version }}"
          AI_SUMMARY="${{ steps.ai_summary.outputs.ai_summary }}"

          # Build release body
          RELEASE_BODY=""
          if [ -n "$AI_SUMMARY" ]; then
            RELEASE_BODY="> $AI_SUMMARY

          "
          fi
          RELEASE_BODY+=$(cat /tmp/changelog.md)

          # Create release
          PRERELEASE_FLAG=""
          if [ "${{ github.event.inputs.prerelease }}" == "true" ]; then
            PRERELEASE_FLAG="--prerelease"
          fi

          echo "$RELEASE_BODY" | gh release create "$NEW_VERSION" \
            --title "Release $NEW_VERSION" \
            --notes-file - \
            $PRERELEASE_FLAG

          echo "Release created: $NEW_VERSION"

      - name: Summary
        run: |
          echo "## Release Created Successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** v${{ steps.bump.outputs.new_version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Type:** ${{ github.event.inputs.bump_type }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -n "${{ steps.ai_summary.outputs.ai_summary }}" ]; then
            echo "### AI Summary" >> $GITHUB_STEP_SUMMARY
            echo "${{ steps.ai_summary.outputs.ai_summary }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          echo "### Changelog" >> $GITHUB_STEP_SUMMARY
          cat /tmp/changelog.md >> $GITHUB_STEP_SUMMARY
