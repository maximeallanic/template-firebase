name: Mobile Store Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      platform:
        description: 'Platform to build and deploy'
        required: true
        default: 'both'
        type: choice
        options:
          - ios
          - android
          - both
      track:
        description: 'Release track'
        required: true
        default: 'internal'
        type: choice
        options:
          - internal    # TestFlight / Play Store Internal
          - beta        # External TestFlight / Play Store Beta
          - production  # App Store / Play Store Production

env:
  NODE_VERSION: '22'
  RUBY_VERSION: '3.2'

jobs:
  # ============================================
  # iOS Build and Deploy to App Store
  # ============================================
  deploy-ios:
    name: Deploy iOS to App Store
    runs-on: macos-latest
    if: |
      github.event.inputs.platform == 'ios' ||
      github.event.inputs.platform == 'both' ||
      github.event.inputs.platform == ''
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Create production .env file
        run: |
          cat > .env << EOF
          VITE_FIREBASE_API_KEY=${{ secrets.VITE_FIREBASE_API_KEY }}
          VITE_FIREBASE_AUTH_DOMAIN=${{ secrets.VITE_FIREBASE_AUTH_DOMAIN }}
          VITE_FIREBASE_PROJECT_ID=${{ secrets.VITE_FIREBASE_PROJECT_ID }}
          VITE_FIREBASE_STORAGE_BUCKET=${{ secrets.VITE_FIREBASE_STORAGE_BUCKET }}
          VITE_FIREBASE_MESSAGING_SENDER_ID=${{ secrets.VITE_FIREBASE_MESSAGING_SENDER_ID }}
          VITE_FIREBASE_APP_ID=${{ secrets.VITE_FIREBASE_APP_ID }}
          VITE_FIREBASE_MEASUREMENT_ID=${{ secrets.VITE_FIREBASE_MEASUREMENT_ID }}
          VITE_FIREBASE_DATABASE_URL=${{ secrets.VITE_FIREBASE_DATABASE_URL }}
          EOF

      - name: Build web app
        run: npm run build

      - name: Sync Capacitor for iOS
        run: npx cap sync ios

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ env.RUBY_VERSION }}
          bundler-cache: true
          working-directory: ios/App

      - name: Install CocoaPods
        working-directory: ios/App
        run: pod install

      - name: Determine release track
        id: track
        run: |
          if [ "${{ github.event_name }}" == "push" ]; then
            # Tag push defaults to internal/testflight
            echo "track=beta" >> $GITHUB_OUTPUT
            echo "ios_lane=beta" >> $GITHUB_OUTPUT
          else
            # Manual dispatch uses selected track
            TRACK="${{ github.event.inputs.track }}"
            case "$TRACK" in
              "internal"|"beta")
                echo "track=beta" >> $GITHUB_OUTPUT
                echo "ios_lane=beta" >> $GITHUB_OUTPUT
                ;;
              "production")
                echo "track=production" >> $GITHUB_OUTPUT
                echo "ios_lane=release" >> $GITHUB_OUTPUT
                ;;
            esac
          fi

      - name: Extract version from tag
        id: version
        run: |
          if [[ "${{ github.ref_type }}" == "tag" ]]; then
            VERSION="${{ github.ref_name }}"
            VERSION="${VERSION#v}"  # Remove 'v' prefix
            echo "version=$VERSION" >> $GITHUB_OUTPUT
          else
            VERSION=$(node -p "require('./package.json').version")
            echo "version=$VERSION" >> $GITHUB_OUTPUT
          fi

      - name: Update iOS version
        working-directory: ios/App
        run: |
          # Update marketing version
          /usr/libexec/PlistBuddy -c "Set :CFBundleShortVersionString ${{ steps.version.outputs.version }}" App/Info.plist

          # Build number will be set by Fastlane

      - name: Build iOS IPA
        working-directory: ios/App
        env:
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_API_KEY_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ISSUER_ID }}
          APP_STORE_CONNECT_API_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_API_KEY_CONTENT }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          ITC_TEAM_ID: ${{ secrets.ITC_TEAM_ID }}
          MATCH_GIT_URL: ${{ secrets.MATCH_GIT_URL }}
          MATCH_GIT_BASIC_AUTHORIZATION: ${{ secrets.MATCH_GIT_BASIC_AUTHORIZATION }}
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
          BUILD_NUMBER: ${{ github.run_number }}
        run: bundle exec fastlane build_release

      - name: Upload iOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ios-ipa
          path: ios/App/build/*.ipa
          retention-days: 30

      - name: Upload to TestFlight
        if: steps.track.outputs.ios_lane == 'beta'
        working-directory: ios/App
        env:
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_API_KEY_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ISSUER_ID }}
          APP_STORE_CONNECT_API_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_API_KEY_CONTENT }}
        run: bundle exec fastlane upload_testflight

      - name: Upload to App Store
        if: steps.track.outputs.ios_lane == 'release'
        working-directory: ios/App
        env:
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_API_KEY_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ISSUER_ID }}
          APP_STORE_CONNECT_API_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_API_KEY_CONTENT }}
        run: bundle exec fastlane upload_appstore

      - name: iOS deployment summary
        run: |
          echo "## iOS Deployment Successful! :apple:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Build:** ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "**Track:** ${{ steps.track.outputs.track }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.track.outputs.track }}" == "beta" ]; then
            echo "The build is now processing on TestFlight." >> $GITHUB_STEP_SUMMARY
          else
            echo "The build has been submitted for App Store review." >> $GITHUB_STEP_SUMMARY
          fi

  # ============================================
  # Android Build and Deploy to Play Store
  # ============================================
  deploy-android:
    name: Deploy Android to Play Store
    runs-on: ubuntu-latest
    if: |
      github.event.inputs.platform == 'android' ||
      github.event.inputs.platform == 'both' ||
      github.event.inputs.platform == ''
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Create production .env file
        run: |
          cat > .env << EOF
          VITE_FIREBASE_API_KEY=${{ secrets.VITE_FIREBASE_API_KEY }}
          VITE_FIREBASE_AUTH_DOMAIN=${{ secrets.VITE_FIREBASE_AUTH_DOMAIN }}
          VITE_FIREBASE_PROJECT_ID=${{ secrets.VITE_FIREBASE_PROJECT_ID }}
          VITE_FIREBASE_STORAGE_BUCKET=${{ secrets.VITE_FIREBASE_STORAGE_BUCKET }}
          VITE_FIREBASE_MESSAGING_SENDER_ID=${{ secrets.VITE_FIREBASE_MESSAGING_SENDER_ID }}
          VITE_FIREBASE_APP_ID=${{ secrets.VITE_FIREBASE_APP_ID }}
          VITE_FIREBASE_MEASUREMENT_ID=${{ secrets.VITE_FIREBASE_MEASUREMENT_ID }}
          VITE_FIREBASE_DATABASE_URL=${{ secrets.VITE_FIREBASE_DATABASE_URL }}
          EOF

      - name: Build web app
        run: npm run build

      - name: Sync Capacitor for Android
        run: npx cap sync android

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ env.RUBY_VERSION }}
          bundler-cache: true
          working-directory: android

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Determine release track
        id: track
        run: |
          if [ "${{ github.event_name }}" == "push" ]; then
            # Tag push defaults to internal
            echo "track=internal" >> $GITHUB_OUTPUT
            echo "android_lane=internal" >> $GITHUB_OUTPUT
          else
            # Manual dispatch uses selected track
            TRACK="${{ github.event.inputs.track }}"
            case "$TRACK" in
              "internal")
                echo "track=internal" >> $GITHUB_OUTPUT
                echo "android_lane=internal" >> $GITHUB_OUTPUT
                ;;
              "beta")
                echo "track=beta" >> $GITHUB_OUTPUT
                echo "android_lane=beta" >> $GITHUB_OUTPUT
                ;;
              "production")
                echo "track=production" >> $GITHUB_OUTPUT
                echo "android_lane=release" >> $GITHUB_OUTPUT
                ;;
            esac
          fi

      - name: Extract version from tag
        id: version
        run: |
          if [[ "${{ github.ref_type }}" == "tag" ]]; then
            VERSION="${{ github.ref_name }}"
            VERSION="${VERSION#v}"  # Remove 'v' prefix
            echo "version=$VERSION" >> $GITHUB_OUTPUT
          else
            VERSION=$(node -p "require('./package.json').version")
            echo "version=$VERSION" >> $GITHUB_OUTPUT
          fi
          # Calculate build number: base 10000 + run_number to ensure > 10001
          BUILD_NUM=$((10000 + ${{ github.run_number }}))
          echo "build_number=$BUILD_NUM" >> $GITHUB_OUTPUT

      - name: Update Android version
        working-directory: android
        run: |
          # Update versionCode in build.gradle
          sed -i "s/versionCode [0-9]*/versionCode ${{ steps.version.outputs.build_number }}/" app/build.gradle
          # Update versionName in build.gradle
          sed -i "s/versionName \".*\"/versionName \"${{ steps.version.outputs.version }}\"/" app/build.gradle
          echo "Updated build.gradle with versionCode=${{ steps.version.outputs.build_number }} versionName=${{ steps.version.outputs.version }}"
          grep -E "versionCode|versionName" app/build.gradle

      - name: Decode keystore
        run: |
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 -d > android/app/release.keystore

      - name: Build Android AAB
        working-directory: android
        env:
          KEYSTORE_PATH: ${{ github.workspace }}/android/app/release.keystore
          KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
          BUILD_NUMBER: ${{ steps.version.outputs.build_number }}
        run: bundle exec fastlane build_release

      - name: Upload Android artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-aab
          path: android/app/build/outputs/bundle/release/*.aab
          retention-days: 30

      - name: Upload to Play Store
        working-directory: android
        env:
          PLAY_STORE_CREDENTIALS: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
        run: |
          bundle exec fastlane supply \
            --aab app/build/outputs/bundle/release/app-release.aab \
            --track ${{ steps.track.outputs.track }} \
            --package_name com.spicyvssweet.app \
            --json_key_data "$PLAY_STORE_CREDENTIALS" \
            --skip_upload_metadata \
            --skip_upload_images \
            --skip_upload_screenshots

      - name: Clean up keystore
        if: always()
        run: rm -f android/app/release.keystore

      - name: Android deployment summary
        run: |
          echo "## Android Deployment Successful! :robot:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Build:** ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "**Track:** ${{ steps.track.outputs.track }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          case "${{ steps.track.outputs.track }}" in
            "internal")
              echo "The build is available on the Internal testing track." >> $GITHUB_STEP_SUMMARY
              ;;
            "beta")
              echo "The build is available on the Open testing track." >> $GITHUB_STEP_SUMMARY
              ;;
            "production")
              echo "The build has been submitted for Production release." >> $GITHUB_STEP_SUMMARY
              ;;
          esac

  # ============================================
  # Create GitHub Release Assets
  # ============================================
  upload-release-assets:
    name: Upload Release Assets
    needs: [deploy-ios, deploy-android]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: Download iOS artifact
        uses: actions/download-artifact@v4
        with:
          name: ios-ipa
          path: artifacts/ios
        continue-on-error: true

      - name: Download Android artifact
        uses: actions/download-artifact@v4
        with:
          name: android-aab
          path: artifacts/android
        continue-on-error: true

      - name: Upload to GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ github.ref_name }}"

          # Upload iOS IPA if exists
          if [ -f artifacts/ios/*.ipa ]; then
            gh release upload "$TAG" artifacts/ios/*.ipa --clobber || true
          fi

          # Upload Android AAB if exists
          if [ -f artifacts/android/*.aab ]; then
            gh release upload "$TAG" artifacts/android/*.aab --clobber || true
          fi
