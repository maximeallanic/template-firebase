rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Users collection
    match /users/{userId} {
      // Users can only read their own data
      allow read: if request.auth != null && request.auth.uid == userId;

      // Allow users to update ONLY their profile fields (profileName, profileAvatar, onboardingProgress)
      // CRITICAL: Users CANNOT modify subscription data (subscriptionStatus, analysesLimit, etc.)
      allow update: if request.auth != null
        && request.auth.uid == userId
        && request.resource.data.diff(resource.data).affectedKeys()
            .hasOnly(['profileName', 'profileAvatar', 'onboardingProgress', 'updatedAt']);

      // Allow users to create their own document with profile fields only
      // (for first-time users before subscription is fetched)
      allow create: if request.auth != null
        && request.auth.uid == userId
        && request.resource.data.keys()
            .hasOnly(['profileName', 'profileAvatar', 'onboardingProgress', 'createdAt', 'updatedAt']);

      // Note: Cloud Functions use Firebase Admin SDK which bypasses these rules
      // and can write directly to any document (for subscription management)

      // User's analysis history subcollection
      match /analyses/{analysisId} {
        allow read: if request.auth != null && request.auth.uid == userId;
        // Users cannot write directly to analyses (only Cloud Functions)
        // This prevents users from fabricating their own analysis history
        allow write: if false;
      }
    }

    // Guest usage tracking (for free trial anti-abuse)
    match /guestUsage/{fingerprint} {
      // No read access (privacy protection)
      allow read: if false;
      // No write access - only Cloud Functions can write
      // Cloud Functions use Admin SDK which bypasses these rules
      allow write: if false;
    }

    // Email analysis sessions (for analyze-by-email feature)
    match /emailSessions/{sessionId} {
      // Authenticated users can read only their own sessions
      allow read: if request.auth != null && resource.data.userId == request.auth.uid;

      // Guests can read only their specific session if they know the exact sessionId
      // This prevents guests from listing all sessions
      // The sessionId is returned by createEmailAnalysisSession and acts as a capability token
      allow read: if request.auth == null &&
                     resource != null &&
                     resource.data.fingerprint != null &&
                     resource.id == sessionId;

      // No write access - only Cloud Functions can write
      // Cloud Functions use Admin SDK which bypasses these rules
      allow write: if false;
    }

    // AI-generated questions (stored for reuse)
    match /generatedQuestions/{questionSetId} {
      // Authenticated users can read question sets
      allow read: if request.auth != null;
      // Only Cloud Functions can write (uses Admin SDK which bypasses rules)
      allow write: if false;
    }

    // Individual questions collection (created by generateGameQuestions)
    match /questions/{questionId} {
      // Authenticated users can read questions
      allow read: if request.auth != null;
      // Allow authenticated users to only increment usageCount
      allow update: if request.auth != null
        && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['usageCount']);
      // Only Cloud Functions can create/delete (uses Admin SDK which bypasses rules)
      allow create, delete: if false;
    }

    // Solo mode leaderboard
    match /soloLeaderboard/{entryId} {
      // Anyone can read the leaderboard (public rankings)
      allow read: if true;

      // Authenticated users can submit their own scores
      allow create: if request.auth != null
        && request.resource.data.playerId == request.auth.uid
        && request.resource.data.isAuthenticated == true
        && request.resource.data.keys().hasAll(['playerId', 'playerName', 'playerAvatar', 'score', 'phase1Score', 'phase2Score', 'phase4Score', 'accuracy', 'totalTimeMs', 'isAuthenticated']);

      // Users cannot update or delete leaderboard entries
      allow update, delete: if false;
    }

    // Deny all other access
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
